<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href="/nail-salon-app/manifest.json">
    <title>Nail Salon Turn Manager</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ec4899'/%3E%3Cpath d='M30 40 L50 30 L70 40 L70 65 C70 72 65 75 50 75 C35 75 30 72 30 65 Z' fill='%23f9a8d4'/%3E%3Crect x='45' y='28' width='10' height='15' rx='2' fill='%23e879f9'/%3E%3Cellipse cx='50' cy='55' rx='15' ry='12' fill='white' opacity='0.3'/%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #fce7f3 0%, #f3e8ff 100%);
            min-height: 100vh;
            padding: 16px;
            margin: 0;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 16px;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .title-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .icon {
            width: 32px;
            height: 32px;
            color: #3b82f6;
        }
        h1 {
            font-size: 24px;
            color: #1f2937;
        }
        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6b7280;
        }
        .sync-icon {
            width: 16px;
            height: 16px;
        }
        .sync-icon.synced { color: #10b981; }
        .sync-icon.saving { color: #3b82f6; animation: pulse 1.5s infinite; }
        .sync-icon.error { color: #ef4444; }
        .sync-icon.offline { color: #9ca3af; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:active {
            transform: scale(0.95);
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }
        .btn-primary.active {
            background: #1d4ed8;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        .btn-action {
            padding: 18px 24px !important;
            font-size: 17px !important;
            font-weight: 700 !important;
            min-width: 120px;
            min-height: 56px;
        }
        .btn-edit {
            background: #f59e0b;
            color: white;
        }
        .btn-edit:hover {
            background: #d97706;
        }
        .btn-edit.active {
            background: #10b981;
        }
        .btn-edit.active:hover {
            background: #059669;
        }
        .drag-handle {
            cursor: move;
            padding: 8px;
            color: #3b82f6;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            font-weight: bold;
        }
        .drag-handle:active {
            cursor: grabbing;
            color: #1d4ed8;
            transform: scale(1.2);
        }
        .employee-row.dragging {
            opacity: 0.3;
            background: #dbeafe;
            border: 3px dashed #3b82f6;
        }
        .employee-row.drag-over {
            background: #fbbf24;
            border: 4px solid #f59e0b;
            transform: scale(1.05);
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
        }
        .employee-row.drag-over::before {
            content: '‚¨áÔ∏è DROP HERE';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #f59e0b;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            z-index: 1000;
            white-space: nowrap;
        }
        .employee-row {
            position: relative;
        }
        button:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .icon-btn {
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .next-banner {
            background: #3b82f6;
            color: white;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin-bottom: 24px;
        }
        .next-banner p:first-child {
            font-size: 14px;
            margin-bottom: 4px;
        }
        .next-banner .name {
            font-size: 28px;
            font-weight: bold;
            margin: 4px 0;
        }
        .next-banner .turn {
            font-size: 20px;
        }
        .edit-mode-banner {
            display: none;
            margin-bottom: 16px;
            padding: 16px;
            background: #fef3c7;
            border-radius: 8px;
            border: 2px solid #f59e0b;
        }
        .edit-mode-banner.active {
            display: block;
        }
        .edit-mode-banner p {
            color: #92400e;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .add-employee {
            display: flex;
            gap: 8px;
        }
        .add-employee input {
            flex: 1;
            padding: 12px;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            font-size: 16px;
        }
        .add-employee input:focus {
            outline: none;
            border-color: #d97706;
        }
        .working-count {
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .employee-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .employee-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            background: #f9fafb;
            position: relative;
            min-height: 70px;
        }
        .employee-row::after {
            content: '';
            position: absolute;
            top: -10px;
            left: 0;
            right: 0;
            bottom: -10px;
            pointer-events: none;
        }
        .employee-row.working {
            background: #fef3c7;
            border-color: #fbbf24;
        }
        .employee-row.half-turn {
            background: #dbeafe;
            border-color: #93c5fd;
        }
        .half-turn-btn {
            padding: 6px 10px;
            background: #e0f2fe;
            color: #0369a1;
            border: 2px solid #bae6fd;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 40px;
            min-height: 40px;
        }
        .half-turn-btn:hover {
            background: #bae6fd;
            border-color: #0369a1;
        }
        .half-turn-btn.active {
            background: #0369a1;
            color: white;
            border-color: #0369a1;
        }
        .employee-row.edit-mode-row {
            touch-action: none;
            cursor: move;
        }
        .employee-row:not(.edit-mode-row) {
            cursor: default;
            user-select: text;
            -webkit-user-select: text;
        }
        .employee-name {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .employee-name span {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        .employee-name input {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            border: 2px solid #3b82f6;
            border-radius: 6px;
            padding: 4px 8px;
        }
        .edit-btn, .remove-btn {
            padding: 4px;
            background: transparent;
            color: #9ca3af;
            border: none;
            cursor: pointer;
        }
        .edit-btn:hover {
            color: #3b82f6;
        }
        .remove-btn:hover {
            color: #ef4444;
        }
        .turn-input {
            width: 80px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6;
            border: 2px solid #93c5fd;
            border-radius: 8px;
            padding: 8px;
        }
        .turn-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .working-label {
            font-size: 16px;
            font-weight: bold;
            color: #d97706;
            padding: 0 12px;
        }
        .update-banner {
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 16px;
            text-align: center;
            font-weight: 600;
        }
        .update-banner a {
            color: white;
            text-decoration: underline;
            font-weight: bold;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1000;
            right: 0;
            top: 100%;
            margin-top: 8px;
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-content button {
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: #1f2937;
        }
        .dropdown-content button:hover {
            background: #f3f4f6;
        }
        .dropdown-content button:first-child {
            border-radius: 8px 8px 0 0;
        }
        .dropdown-content button:last-child {
            border-radius: 0 0 8px 8px;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .employee-info-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .employee-info-card .info {
            flex: 1;
        }
        .employee-info-card h3 {
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 18px;
        }
        .employee-info-card p {
            color: #6b7280;
            margin: 4px 0;
        }
        .employee-info-card .actions {
            display: flex;
            gap: 8px;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .date-inputs {
            display: flex;
            gap: 12px;
        }
        .date-inputs input {
            flex: 1;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
        }
        .modal-content h3 {
            margin-bottom: 16px;
            font-size: 20px;
            color: #1f2937;
        }
        .modal-content p {
            margin-bottom: 12px;
            color: #6b7280;
            line-height: 1.5;
        }
        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        .modal-content input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .btn-secondary {
            background: #e5e7eb;
            color: #1f2937;
        }
        .btn-secondary:hover {
            background: #d1d5db;
        }
        .setup-card {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .setup-card h2 {
            color: #92400e;
            margin-bottom: 16px;
            font-size: 22px;
        }
        .setup-card h3 {
            color: #78350f;
            margin-top: 16px;
            margin-bottom: 8px;
            font-size: 18px;
        }
        .setup-card p, .setup-card li {
            color: #78350f;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .setup-card code {
            background: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #dc2626;
        }
        .setup-card ol {
            margin-left: 24px;
            margin-top: 12px;
        }
        .setup-card li {
            margin-bottom: 12px;
        }
        .setup-card strong {
            color: #92400e;
        }
        .setup-card a {
            color: #2563eb;
            text-decoration: underline;
        }
        .code-block {
            background: #1f2937;
            color: #e5e7eb;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 12px 0;
            line-height: 1.5;
        }
        .warning-box {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
        }
        .warning-box p {
            color: #991b1b;
            margin: 0;
        }
        
        /* Audit Log Styles */
        .audit-log-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .audit-log-item.add { border-left: 4px solid #10b981; }
        .audit-log-item.edit { border-left: 4px solid #3b82f6; }
        .audit-log-item.delete { border-left: 4px solid #ef4444; }
        .audit-log-item.hide { border-left: 4px solid #f59e0b; }
        .audit-log-item.turn { border-left: 4px solid #8b5cf6; }
        .audit-log-item.working { border-left: 4px solid #f59e0b; }
        .audit-log-item.done { border-left: 4px solid #10b981; }
        .audit-log-item.clear { border-left: 4px solid #6b7280; }
        .audit-log-item.reorder { border-left: 4px solid #06b6d4; }
        
        .audit-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .audit-log-action {
            font-weight: 600;
            color: #1f2937;
            font-size: 16px;
        }
        .audit-log-time {
            color: #6b7280;
            font-size: 13px;
        }
        .audit-log-details {
            color: #4b5563;
            font-size: 14px;
            line-height: 1.5;
        }
        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .filter-btn {
            padding: 6px 12px;
            font-size: 13px;
            background: #e5e7eb;
            color: #1f2937;
        }
        .filter-btn.active {
            background: #3b82f6;
            color: white;
        }
        .passcode-input {
            text-align: center;
            font-size: 24px;
            letter-spacing: 8px;
            font-weight: bold;
        }
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 8px;
            text-align: center;
        }
        
        /* Timer Styles */
        .timer-display {
            font-size: 20px;
            font-weight: bold;
            color: #3b82f6;
            min-width: 80px;
            text-align: center;
        }
        .timer-display.warning {
            color: #f59e0b;
        }
        .timer-display.danger {
            color: #ef4444;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        
        /* History Styles */
        .history-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #10b981;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .history-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 18px;
        }
        .history-date {
            color: #6b7280;
            font-size: 14px;
        }
        .history-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            color: #4b5563;
            font-size: 14px;
        }
        .history-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .history-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .date-filter {
            padding: 8px 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* Settings/Toggle Styles */
        .settings-section {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-section h3 {
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 12px;
        }
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374151;
            font-weight: 500;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background-color: #d1d5db;
            border-radius: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .toggle-switch.active {
            background-color: #10b981;
        }
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch.active .toggle-slider {
            transform: translateX(22px);
        }
        .toggle-switch.disabled {
            background-color: #e5e7eb;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .toggle-switch.disabled .toggle-slider {
            background-color: #d1d5db;
        }
    </style>
</head>
<body>
    <div class="container page active" id="mainPage">
        <div class="card">
            <div class="header">
                <div class="title-group">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <div>
                        <h1>Employee Turns V26</h1>
                        <div class="sync-status">
                            <svg class="sync-icon offline" id="syncIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                            </svg>
                            <span id="syncText">Offline mode - Configure Firebase</span>
                        </div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-edit" onclick="showPasscodeModal()" id="editModeBtn">Edit</button>
                    <button class="btn-danger" onclick="cancelEdit()" id="cancelBtn" style="display:none;">Cancel</button>
                    <div class="dropdown">
                        <button class="btn-primary" onclick="toggleDropdown()">‚ò∞ Menu</button>
                        <div class="dropdown-content" id="dropdownMenu">
                            <button onclick="showSettings()">‚öôÔ∏è Settings</button>
                            <button onclick="showEmployeeList()">üë• Employee List</button>
                            <button onclick="showWorkHistory()">üïê Work History</button>
                            <button onclick="showAuditLog()">üìã Audit Log</button>
                        </div>
                    </div>
                    <button class="icon-btn btn-primary" onclick="undo()" id="undoBtn" disabled>
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                        </svg>
                    </button>
                    <button class="icon-btn btn-primary" onclick="redo()" id="redoBtn" disabled>
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/>
                        </svg>
                    </button>
                    <button class="btn-danger" onclick="showClearModal()">Clear All</button>
                </div>
            </div>

            <div id="nextBanner"></div>
            
            <p class="working-count" id="workingCount"></p>
            <div class="employee-list" id="employeeList"></div>
        </div>

        <div class="update-banner">
            üì± <a href="https://chungling1995.github.io/nail-salon-app/" target="_blank">Download Latest Version</a>
        </div>
    </div>

    <!-- Settings Page -->
    <div class="container page" id="settingsPage">
        <div class="card">
            <div class="header">
                <div class="title-group">
                    <button class="btn-secondary" onclick="showMainPage()">‚Üê Back</button>
                    <h1>‚öôÔ∏è Settings</h1>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Display Options</h3>
                <div class="toggle-container">
                    <div class="toggle-label">
                        <span>‚è±Ô∏è</span>
                        <span>Show Timer on Main Page</span>
                    </div>
                    <div class="toggle-switch" id="timerToggle" onclick="toggleTimerDisplay()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <p style="color: #6b7280; font-size: 13px; margin-top: 8px; padding: 0 12px;">
                    When disabled, timer will still track in background for work history but won't be displayed on the main page.
                </p>
            </div>

            <div class="settings-section">
                <h3>Data Sync</h3>
                <div class="toggle-container">
                    <div class="toggle-label">
                        <span>‚òÅÔ∏è</span>
                        <span>Firebase Cloud Sync</span>
                    </div>
                    <div class="toggle-switch" id="syncToggle" onclick="toggleSyncMode()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <p style="color: #6b7280; font-size: 13px; margin-top: 8px; padding: 0 12px;" id="syncDescription">
                    When disabled, all data is saved locally only. Enable to sync data across devices via Firebase.
                </p>
                <div id="firebaseStatus" style="margin-top: 12px; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 13px;">
                    <strong>Status:</strong> <span id="firebaseStatusText">Checking...</span>
                </div>
            </div>

            <div class="settings-section">
                <h3>Security</h3>
                <div style="padding: 12px;">
                    <p style="color: #6b7280; font-size: 13px; margin-bottom: 12px;">
                        Change your passcode for Edit Mode access. Syncs to Firebase if enabled.
                    </p>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <input type="password" 
                               id="newPasscodeInput" 
                               class="passcode-input"
                               placeholder="New 4-digit code"
                               maxlength="4"
                               inputmode="numeric"
                               pattern="[0-9]*"
                               style="flex: 1; min-width: 150px;">
                        <button class="btn-primary" onclick="changePasscode()">Update Passcode</button>
                    </div>
                    <div id="passcodeChangeMessage" style="margin-top: 8px; font-size: 13px; display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee List Page -->
    <div class="container page" id="employeeListPage">
        <div class="card">
            <div class="header">
                <div class="title-group">
                    <button class="btn-secondary" onclick="showMainPage()">‚Üê Back</button>
                    <h1>Employee List</h1>
                </div>
                <button class="btn-success" onclick="showAddEmployeeModal()">‚ûï Add New</button>
            </div>
            <div id="employeeInfoList"></div>
        </div>
    </div>

    <!-- Audit Log Page -->
    <div class="container page" id="auditLogPage">
        <div class="card">
            <div class="header">
                <div class="title-group">
                    <button class="btn-secondary" onclick="showMainPage()">‚Üê Back</button>
                    <h1>üìã Audit Log</h1>
                </div>
                <button class="btn-danger btn-small" onclick="clearAuditLog()">Clear Log</button>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterAuditLog('all')">All</button>
                <button class="filter-btn" onclick="filterAuditLog('add')">Added</button>
                <button class="filter-btn" onclick="filterAuditLog('edit')">Edited</button>
                <button class="filter-btn" onclick="filterAuditLog('delete')">Deleted</button>
                <button class="filter-btn" onclick="filterAuditLog('turn')">Turn Changes</button>
                <button class="filter-btn" onclick="filterAuditLog('working')">Status Changes</button>
            </div>
            
            <div id="auditLogList"></div>
        </div>
    </div>

    <!-- Work History Page -->
    <div class="container page" id="workHistoryPage">
        <div class="card">
            <div class="header">
                <div class="title-group">
                    <button class="btn-secondary" onclick="showMainPage()">‚Üê Back</button>
                    <h1>üïê Work History</h1>
                </div>
                <button class="btn-danger btn-small" onclick="clearWorkHistory()">Clear History</button>
            </div>
            
            <div class="history-filters">
                <input type="date" id="filterStartDate" class="date-filter" onchange="filterWorkHistory()">
                <span style="align-self: center;">to</span>
                <input type="date" id="filterEndDate" class="date-filter" onchange="filterWorkHistory()">
                <button class="btn-primary btn-small" onclick="clearWorkHistoryFilter()">Show All</button>
            </div>
            
            <div id="workHistoryList"></div>
        </div>
    </div>

    <!-- Passcode Modal -->
    <div class="modal" id="passcodeModal">
        <div class="modal-content">
            <h3 id="passcodeModalTitle">üîí Enter Passcode</h3>
            <p id="passcodeModalText">Enter passcode to access Edit Mode</p>
            <input type="password" 
                   id="passcodeInput" 
                   class="passcode-input"
                   placeholder="****"
                   maxlength="4"
                   inputmode="numeric"
                   pattern="[0-9]*"
                   oninput="if(this.value.length === 4) checkPasscode()">
            <div id="passcodeError" class="error-message" style="display:none;">Incorrect passcode. Please try again.</div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hidePasscodeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal" id="addEmployeeModal">
        <div class="modal-content">
            <h3 id="addModalTitle">‚ûï Add New Employee</h3>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="newEmpName" placeholder="Enter employee name">
            </div>
            <div class="form-group">
                <label>Birthday:</label>
                <div class="date-inputs">
                    <input type="number" id="newEmpMonth" placeholder="Month (1-12)" min="1" max="12">
                    <input type="number" id="newEmpDay" placeholder="Day (1-31)" min="1" max="31">
                </div>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="newEmpBirthdayReminder" checked style="width: auto; cursor: pointer;">
                    <span>Show birthday cake reminder üéÇ</span>
                </label>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideAddEmployeeModal()">Cancel</button>
                <button class="btn-success" id="addModalBtn" onclick="confirmAddEmployee()">Add Employee</button>
            </div>
        </div>
    </div>

    <!-- Hide Employee Confirmation Modal -->
    <div class="modal" id="hideEmployeeModal">
        <div class="modal-content">
            <h3>Hide Employee?</h3>
            <p id="hideEmployeeText"></p>
            <p style="color: #6b7280; font-size: 14px;">(They will return when you click "Clear All")</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="cancelHideEmployee()">Cancel</button>
                <button class="btn-warning" onclick="confirmHideEmployee()">Yes, Hide</button>
            </div>
        </div>
    </div>

    <!-- Delete Employee Confirmation Modal -->
    <div class="modal" id="deleteEmployeeModal">
        <div class="modal-content">
            <h3 style="color: #dc2626;">‚ö†Ô∏è PERMANENT DELETE</h3>
            <p id="deleteEmployeeText"></p>
            <p style="color: #991b1b; font-weight: 600;">This action CANNOT be undone!</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="cancelDeleteEmployee()">Cancel</button>
                <button class="btn-danger" onclick="confirmDeleteEmployee()">Delete Permanently</button>
            </div>
        </div>
    </div>

    <!-- Clear All Modal -->
    <div class="modal" id="clearModal">
        <div class="modal-content">
            <h3>Clear All?</h3>
            <p>This will reset all turn numbers and working status. Are you sure?</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideClearModal()">Cancel</button>
                <button class="btn-danger" onclick="confirmClearAll()">Yes, Clear All</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        
        let EDIT_PASSCODE = "1314";
        let passcodeMode = 'edit'; // 'edit' or 'settings'
        
        // REPLACE WITH YOUR FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyDDtDd7KrMcvPA-1QluxKQvco0sLa_kWdk",
  authDomain: "nail-salon-d962b.firebaseapp.com",
  projectId: "nail-salon-d962b",
  storageBucket: "nail-salon-d962b.firebasestorage.app",
  messagingSenderId: "1076505113914",
  appId: "1:1076505113914:web:7a0a80d1cd4781357c8c03"
};

        // ========================================
        // FIREBASE INITIALIZATION
        // ========================================
        let db = null;
        let firebaseEnabled = false;
        let firebaseListener = null; // Store listener so we can unsubscribe

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseEnabled = true;
                console.log('‚úÖ Firebase initialized successfully');
            } else {
                console.log('‚ö†Ô∏è Firebase not configured - using offline mode');
            }
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
        }

        // ========================================
        // APP STATE
        // ========================================
        let employees = [
            { name: 'Hai', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true },
            { name: 'Jessica', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true },
            { name: 'Tu·∫•n', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true },
            { name: 'Chien', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true },
            { name: 'Queenie', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true },
            { name: 'Ling', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true },
            { name: 'Huy·ªÅn', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true },
            { name: 'Katey', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true },
            { name: 'Li·ªÖu', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true },
            { name: 'Duy√™n', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true },
            { name: 'C∆∞·ªùng', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true },
            { name: 'Chung', turn: null, status: 'waiting', birthMonth: null, birthDay: null, birthdayReminderEnabled: true }
        ];
        let history = [];
        let historyIndex = -1;
        let editingIndex = null;
        let editMode = false;
        let syncStatus = 'offline';
        let lastSync = null;
        let wakeLock = null;
        let employeesBackup = null;
        let draggedIndex = null;
        let editingEmployeeIndex = null;
        let pendingHideIndex = null;
        let pendingDeleteIndex = null;
        let auditLog = [];
        let currentAuditFilter = 'all';
        let workHistory = [];
        let timerIntervals = {};
        let startTimes = {};
        let showTimer = true; // New setting for timer visibility
        let syncEnabled = true; // New setting for Firebase sync on/off
        let lastLocalUpdate = 0; // Timestamp of last local change to prevent sync overwrites
        let syncLockUntil = 0; // Temporary lock to prevent sync during rapid local changes


        // ========================================
        // SETTINGS FUNCTIONS
        // ========================================
        function loadSettings() {
            const savedSettings = localStorage.getItem('nailSalonSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                showTimer = settings.showTimer !== undefined ? settings.showTimer : true;
                syncEnabled = settings.syncEnabled !== undefined ? settings.syncEnabled : true;
            }
            updateTimerToggle();
            updateSyncToggle();
        }

        function saveSettings() {
            const settings = {
                showTimer: showTimer,
                syncEnabled: syncEnabled
            };
            localStorage.setItem('nailSalonSettings', JSON.stringify(settings));
        }

        function toggleTimerDisplay() {
            showTimer = !showTimer;
            saveSettings();
            updateTimerToggle();
            render();
            addAuditLog('working', `Timer display ${showTimer ? 'enabled' : 'disabled'}`);
        }

        function updateTimerToggle() {
            const toggle = document.getElementById('timerToggle');
            if (showTimer) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        function toggleSyncMode() {
            // Don't allow toggling if Firebase is not configured
            if (!firebaseEnabled) {
                alert('Firebase is not configured. Please set up your Firebase credentials in the code to enable cloud sync.');
                return;
            }
            
            syncEnabled = !syncEnabled;
            saveSettings();
            updateSyncToggle();
            
            if (syncEnabled && firebaseEnabled) {
                // Re-enable sync and start listener
                startFirebaseListener();
                addAuditLog('working', 'Firebase sync enabled');
            } else {
                // Disable sync and stop listener
                if (firebaseListener) {
                    firebaseListener(); // Call unsubscribe function
                    firebaseListener = null;
                }
                updateSyncStatus('offline');
                addAuditLog('working', 'Firebase sync disabled - working offline');
            }
        }

        function updateSyncToggle() {
            const toggle = document.getElementById('syncToggle');
            if (toggle) {
                // Remove all state classes first
                toggle.classList.remove('active', 'disabled');
                
                if (!firebaseEnabled) {
                    toggle.classList.add('disabled');
                } else if (syncEnabled) {
                    toggle.classList.add('active');
                }
            }
            updateFirebaseStatus();
        }

        function updateFirebaseStatus() {
            const statusText = document.getElementById('firebaseStatusText');
            if (!statusText) return;
            
            if (!firebaseEnabled) {
                statusText.innerHTML = 'üî¥ <strong>Not Configured</strong> - Firebase credentials not set up';
                statusText.style.color = '#dc2626';
            } else if (syncEnabled) {
                statusText.innerHTML = 'üü¢ <strong>Syncing</strong> - Data syncing to cloud';
                statusText.style.color = '#059669';
            } else {
                statusText.innerHTML = 'üü° <strong>Offline Mode</strong> - Sync disabled, data saved locally only';
                statusText.style.color = '#d97706';
            }
        }

        function showSettings() {
            showPasscodeModal('settings');
        }

        // ========================================
        // AUDIT LOG FUNCTIONS
        // ========================================
        function addAuditLog(action, details) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details
            };
            auditLog.unshift(logEntry);
            
            if (auditLog.length > 500) {
                auditLog = auditLog.slice(0, 500);
            }
            
            saveAuditLog();
        }

        function saveAuditLog() {
            localStorage.setItem('nailSalonAuditLog', JSON.stringify(auditLog));
        }

        function loadAuditLog() {
            const saved = localStorage.getItem('nailSalonAuditLog');
            if (saved) {
                auditLog = JSON.parse(saved);
            }
        }

        function clearAuditLog() {
            if (confirm('Are you sure you want to clear all audit logs? This cannot be undone.')) {
                auditLog = [];
                saveAuditLog();
                addAuditLog('clear', 'Audit log cleared');
                renderAuditLog();
            }
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function filterAuditLog(filter) {
            currentAuditFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderAuditLog();
        }

        function renderAuditLog() {
            const list = document.getElementById('auditLogList');
            
            let filteredLog = auditLog;
            if (currentAuditFilter !== 'all') {
                filteredLog = auditLog.filter(entry => entry.action === currentAuditFilter);
            }
            
            if (filteredLog.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No audit logs found</p>';
                return;
            }
            
            list.innerHTML = filteredLog.map(entry => `
                <div class="audit-log-item ${entry.action}">
                    <div class="audit-log-header">
                        <span class="audit-log-action">${getActionIcon(entry.action)} ${getActionLabel(entry.action)}</span>
                        <span class="audit-log-time">${formatTimestamp(entry.timestamp)}</span>
                    </div>
                    <div class="audit-log-details">${entry.details}</div>
                </div>
            `).join('');
        }

        function getActionIcon(action) {
            const icons = {
                'add': '‚ûï',
                'edit': '‚úèÔ∏è',
                'delete': 'üóëÔ∏è',
                'hide': 'üëÅÔ∏è',
                'turn': 'üî¢',
                'working': '‚öôÔ∏è',
                'done': '‚úÖ',
                'clear': 'üîÑ',
                'reorder': '‚ÜïÔ∏è'
            };
            return icons[action] || 'üìù';
        }

        function getActionLabel(action) {
            const labels = {
                'add': 'Added Employee',
                'edit': 'Edited Employee',
                'delete': 'Deleted Employee',
                'hide': 'Hidden Employee',
                'turn': 'Turn Changed',
                'working': 'Status Changed',
                'done': 'Completed Work',
                'clear': 'System Reset',
                'reorder': 'Reordered List'
            };
            return labels[action] || 'Action';
        }

        function showAuditLog() {
            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('settingsPage').classList.remove('active');
            document.getElementById('employeeListPage').classList.remove('active');
            document.getElementById('auditLogPage').classList.add('active');
            document.getElementById('workHistoryPage').classList.remove('active');
            document.getElementById('dropdownMenu').classList.remove('show');
            renderAuditLog();
        }

        // ========================================
        // TIMER FUNCTIONS
        // ========================================
        function startTimer(index) {
            const employee = employees[index];
            employee.workStartTime = Date.now();
            
            if (timerIntervals[index]) {
                clearInterval(timerIntervals[index]);
            }
            
            timerIntervals[index] = setInterval(() => {
                updateTimerDisplays();
            }, 1000);
        }

        function updateTimerDisplays() {
            employees.forEach((emp, index) => {
                if (emp.status === 'working' && emp.workStartTime) {
                    const timerElement = document.querySelector(`[data-timer-index="${index}"]`);
                    if (timerElement) {
                        timerElement.textContent = getElapsedTime(emp.workStartTime);
                        timerElement.className = 'timer-display ' + getTimerClass(emp.workStartTime);
                    }
                }
            });
        }

        function stopTimer(index) {
            if (timerIntervals[index]) {
                clearInterval(timerIntervals[index]);
                delete timerIntervals[index];
            }
        }

        function getElapsedTime(startTime) {
            if (!startTime) return '00:00';
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        function getTimerClass(startTime) {
            if (!startTime) return '';
            const elapsed = Date.now() - startTime;
            const minutes = elapsed / 60000;
            if (minutes > 90) return 'danger';
            if (minutes > 60) return 'warning';
            return '';
        }

        // ========================================
        // WORK HISTORY FUNCTIONS
        // ========================================
        function saveToWorkHistory(employeeIndex) {
            const employee = employees[employeeIndex];
            if (!employee.workStartTime) return;
            
            const endTime = Date.now();
            const duration = endTime - employee.workStartTime;
            
            const historyEntry = {
                employeeName: employee.name,
                turnNumber: employee.turn,
                startTime: employee.workStartTime,
                endTime: endTime,
                duration: duration,
                date: new Date().toISOString()
            };
            
            workHistory.unshift(historyEntry);
            
            if (workHistory.length > 1000) {
                workHistory = workHistory.slice(0, 1000);
            }
            
            saveWorkHistoryToStorage();
            
            const durationMin = Math.floor(duration / 60000);
            addAuditLog('done', `${employee.name}: Completed work (Duration: ${durationMin} minutes)`);
        }

        function loadWorkHistory() {
            const saved = localStorage.getItem('nailSalonWorkHistory');
            if (saved) {
                workHistory = JSON.parse(saved);
            }
        }

        function saveWorkHistoryToStorage() {
            localStorage.setItem('nailSalonWorkHistory', JSON.stringify(workHistory));
        }

        function clearWorkHistory() {
            if (confirm('Are you sure you want to clear all work history? This cannot be undone.')) {
                workHistory = [];
                saveWorkHistoryToStorage();
                renderWorkHistory();
                addAuditLog('clear', 'Work history cleared');
            }
        }

        function clearWorkHistoryFilter() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            renderWorkHistory();
        }

        function filterWorkHistory() {
            renderWorkHistory();
        }

        function showWorkHistory() {
            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('settingsPage').classList.remove('active');
            document.getElementById('employeeListPage').classList.remove('active');
            document.getElementById('auditLogPage').classList.remove('active');
            document.getElementById('workHistoryPage').classList.add('active');
            document.getElementById('dropdownMenu').classList.remove('show');
            renderWorkHistory();
        }

        function renderWorkHistory() {
            const list = document.getElementById('workHistoryList');
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            let filteredHistory = workHistory;
            
            if (startDate || endDate) {
                filteredHistory = workHistory.filter(entry => {
                    const entryDate = new Date(entry.date).toISOString().split('T')[0];
                    if (startDate && entryDate < startDate) return false;
                    if (endDate && entryDate > endDate) return false;
                    return true;
                });
            }
            
            if (filteredHistory.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No work history found</p>';
                return;
            }
            
            list.innerHTML = filteredHistory.map(entry => {
                const durationMin = Math.floor(entry.duration / 60000);
                const durationSec = Math.floor((entry.duration % 60000) / 1000);
                const startTime = new Date(entry.startTime);
                const endTime = new Date(entry.endTime);
                
                return `
                    <div class="history-item">
                        <div class="history-header">
                            <span class="history-name">${entry.employeeName}</span>
                            <span class="history-date">${formatTimestamp(entry.date)}</span>
                        </div>
                        <div class="history-details">
                            <div class="history-detail">
                                <span>üî¢ Turn:</span>
                                <span>${entry.turnNumber !== null ? '#' + entry.turnNumber : 'N/A'}</span>
                            </div>
                            <div class="history-detail">
                                <span>‚è±Ô∏è Duration:</span>
                                <span>${durationMin}m ${durationSec}s</span>
                            </div>
                            <div class="history-detail">
                                <span>üïê Start:</span>
                                <span>${startTime.toLocaleTimeString()}</span>
                            </div>
                            <div class="history-detail">
                                <span>üïê End:</span>
                                <span>${endTime.toLocaleTimeString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========================================
        // PASSCODE FUNCTIONS
        // ========================================
        function showPasscodeModal(mode = 'edit') {
            passcodeMode = mode;
            const modal = document.getElementById('passcodeModal');
            const title = document.getElementById('passcodeModalTitle');
            const text = document.getElementById('passcodeModalText');
            
            if (mode === 'settings') {
                title.textContent = '‚öôÔ∏è Enter Passcode';
                text.textContent = 'Enter passcode to access Settings';
            } else {
                title.textContent = 'üîí Enter Passcode';
                text.textContent = 'Enter passcode to access Edit Mode';
            }
            
            modal.classList.add('show');
            document.getElementById('passcodeInput').value = '';
            document.getElementById('passcodeError').style.display = 'none';
            setTimeout(() => {
                document.getElementById('passcodeInput').focus();
            }, 100);
        }

        function hidePasscodeModal() {
            document.getElementById('passcodeModal').classList.remove('show');
            document.getElementById('passcodeInput').value = '';
            document.getElementById('passcodeError').style.display = 'none';
        }

        function checkPasscode() {
            const input = document.getElementById('passcodeInput').value;
            if (input === EDIT_PASSCODE) {
                hidePasscodeModal();
                if (passcodeMode === 'settings') {
                    openSettingsPage();
                } else {
                    toggleEditMode();
                    addAuditLog('working', 'Edit mode activated');
                }
            } else {
                document.getElementById('passcodeError').style.display = 'block';
                document.getElementById('passcodeInput').value = '';
                document.getElementById('passcodeInput').focus();
            }
        }

        function openSettingsPage() {
            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('settingsPage').classList.add('active');
            document.getElementById('employeeListPage').classList.remove('active');
            document.getElementById('auditLogPage').classList.remove('active');
            document.getElementById('workHistoryPage').classList.remove('active');
            document.getElementById('dropdownMenu').classList.remove('show');
            updateFirebaseStatus();
        }

        async function changePasscode() {
            const newCode = document.getElementById('newPasscodeInput').value;
            const messageEl = document.getElementById('passcodeChangeMessage');
            
            if (newCode.length !== 4 || !/^\d{4}$/.test(newCode)) {
                messageEl.textContent = '‚ùå Passcode must be exactly 4 digits';
                messageEl.style.color = '#ef4444';
                messageEl.style.display = 'block';
                return;
            }
            
            EDIT_PASSCODE = newCode;
            
            // Save to localStorage
            localStorage.setItem('editPasscode', newCode);
            
            // Sync to Firebase if enabled
            if (firebaseEnabled && syncEnabled) {
                try {
                    await db.collection('nailSalon').doc('settings').set({
                        passcode: newCode,
                        lastUpdated: new Date().toISOString()
                    });
                    messageEl.textContent = '‚úÖ Passcode updated and synced to cloud';
                } catch (error) {
                    console.error('Error syncing passcode:', error);
                    messageEl.textContent = '‚úÖ Passcode updated locally (cloud sync failed)';
                }
            } else {
                messageEl.textContent = '‚úÖ Passcode updated locally';
            }
            
            messageEl.style.color = '#10b981';
            messageEl.style.display = 'block';
            document.getElementById('newPasscodeInput').value = '';
            
            addAuditLog('working', 'Passcode changed');
            
            // Hide message after 3 seconds
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const passcodeInput = document.getElementById('passcodeInput');
            if (passcodeInput) {
                passcodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPasscode();
                    }
                });
            }
        });

        // ========================================
        // BIRTHDAY FUNCTIONS
        // ========================================
        function shouldShowBirthdayCake(birthMonth, birthDay, birthdayReminderEnabled) {
            if (!birthMonth || !birthDay) return false;
            if (birthdayReminderEnabled === false) return false;
            
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentDay = today.getDate();
            
            return currentMonth === birthMonth && currentDay <= birthDay;
        }

        // ========================================
        // SCREEN WAKE LOCK (PREVENT SLEEP)
        // ========================================
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('‚úÖ Screen wake lock activated - screen will stay on');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake lock released');
                    });
                } else {
                    console.log('‚ö†Ô∏è Wake Lock API not supported on this device');
                }
            } catch (err) {
                console.error('Wake lock error:', err);
            }
        }

        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && wakeLock !== null) {
                await requestWakeLock();
            }
        });

        // ========================================
        // DATA CLEANING HELPER
        // ========================================
        function cleanEmployeeData(employees) {
            // Remove any undefined values from employee objects before saving to Firebase
            // Add timestamps for conflict resolution
            const now = Date.now();
            
            return employees.map(emp => {
                const cleaned = {
                    name: emp.name || '',
                    turn: emp.turn === undefined ? null : emp.turn,
                    status: emp.status || 'waiting',
                    lastUpdated: emp.lastUpdated || now // Track when this employee was last modified
                };
                
                // Only add birthday fields if they're not undefined
                if (emp.birthMonth !== undefined) {
                    cleaned.birthMonth = emp.birthMonth;
                } else {
                    cleaned.birthMonth = null;
                }
                
                if (emp.birthDay !== undefined) {
                    cleaned.birthDay = emp.birthDay;
                } else {
                    cleaned.birthDay = null;
                }
                
                if (emp.birthdayReminderEnabled !== undefined) {
                    cleaned.birthdayReminderEnabled = emp.birthdayReminderEnabled;
                } else {
                    cleaned.birthdayReminderEnabled = true;
                }
                
                // Handle halfTurn field
                if (emp.halfTurn !== undefined) {
                    cleaned.halfTurn = emp.halfTurn;
                } else {
                    cleaned.halfTurn = false;
                }
                
                // Only include workStartTime if it exists and is not undefined
                if (emp.workStartTime !== undefined && emp.workStartTime !== null) {
                    cleaned.workStartTime = emp.workStartTime;
                }
                
                return cleaned;
            });
        }

        // ========================================
        // FIREBASE LISTENER
        // ========================================
        function startFirebaseListener() {
            if (!firebaseEnabled || !syncEnabled) {
                return;
            }
            
            // Stop existing listener if any
            if (firebaseListener) {
                firebaseListener();
                firebaseListener = null;
            }
            
            updateSyncStatus('saving');
            firebaseListener = db.collection('nailSalon').doc('data').onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    const now = Date.now();
                    
                    // Check if we're in a sync lock period (during rapid local changes)
                    if (now < syncLockUntil) {
                        console.log('‚è∏Ô∏è Sync locked - ignoring Firebase update during local changes');
                        updateSyncStatus('synced');
                        return;
                    }
                    
                    // Get timestamps for document-level comparison
                    const remoteTimestamp = data.timestamp || 0;
                    
                    // Get our last sync timestamp from localStorage
                    const localData = localStorage.getItem('nailSalonData');
                    let localTimestamp = 0;
                    if (localData) {
                        const parsed = JSON.parse(localData);
                        localTimestamp = parsed.lastSyncTimestamp || 0;
                    }
                    
                    console.log(`üìä Timestamp comparison: Remote=${remoteTimestamp}, Local=${localTimestamp}, Diff=${remoteTimestamp - localTimestamp}ms`);
                    
                    // If remote timestamp is older or equal to local, ignore it
                    if (remoteTimestamp <= localTimestamp) {
                        console.log('‚è≠Ô∏è Ignoring Firebase data (local is same or newer)');
                        updateSyncStatus('synced');
                        return;
                    }
                    
                    // Remote data is newer - accept it
                    const receivedEmployees = data.employees || employees;
                    
                    // Check if data actually changed
                    if (JSON.stringify(receivedEmployees) === JSON.stringify(employees)) {
                        console.log('‚úì Data is identical, no update needed');
                        // Update our local sync timestamp even if data is same
                        localStorage.setItem('nailSalonData', JSON.stringify({
                            employees: employees,
                            history: history,
                            historyIndex: historyIndex,
                            lastSyncTimestamp: remoteTimestamp
                        }));
                        updateSyncStatus('synced');
                        return;
                    }
                    
                    // Apply remote changes
                    console.log('üì• Accepting newer data from Firebase');
                    employees = receivedEmployees;
                    
                    // Restart any active timers
                    employees.forEach((emp, index) => {
                        if (emp.status === 'working' && emp.workStartTime) {
                            startTimer(index);
                        }
                    });
                    
                    // Save to localStorage with updated sync timestamp
                    localStorage.setItem('nailSalonData', JSON.stringify({
                        employees: employees,
                        history: history,
                        historyIndex: historyIndex,
                        lastSyncTimestamp: remoteTimestamp
                    }));
                    
                    render();
                    updateSyncStatus('synced');
                } else {
                    console.log('Creating initial Firebase document...');
                    saveData();
                }
            }, (error) => {
                console.error('Firebase sync error:', error);
                updateSyncStatus('error');
            });
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        function init() {
            loadData();
            loadAuditLog();
            loadWorkHistory();
            loadSettings();
            loadPasscode();
            
            employees.forEach((emp, index) => {
                if (emp.status === 'working' && emp.workStartTime) {
                    startTimer(index);
                }
            });
            
            // Only set up Firebase sync if both Firebase is enabled AND user has sync enabled
            if (firebaseEnabled && syncEnabled) {
                startFirebaseListener();
                loadPasscodeFromFirebase();
            } else {
                updateSyncStatus('offline');
            }
        }

        function loadPasscode() {
            const saved = localStorage.getItem('editPasscode');
            if (saved) {
                EDIT_PASSCODE = saved;
            }
        }

        async function loadPasscodeFromFirebase() {
            if (!firebaseEnabled) return;
            
            try {
                const doc = await db.collection('nailSalon').doc('settings').get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.passcode) {
                        EDIT_PASSCODE = data.passcode;
                        localStorage.setItem('editPasscode', data.passcode);
                        console.log('‚úÖ Passcode loaded from Firebase');
                    }
                }
            } catch (error) {
                console.error('Error loading passcode from Firebase:', error);
            }
        }

        function loadData() {
            const saved = localStorage.getItem('nailSalonData');
            if (saved) {
                const data = JSON.parse(saved);
                employees = data.employees;
                history = data.history || [employees];
                historyIndex = data.historyIndex || 0;
            } else {
                history = [JSON.parse(JSON.stringify(employees))];
                historyIndex = 0;
            }
            render();
        }

        async function saveData() {
            // Clean employee data to remove any undefined values
            const cleanedEmployees = cleanEmployeeData(employees);
            
            // Limit history size for Firebase to prevent document size limit (1MB max)
            // Keep only the last 20 history states for undo/redo in cloud
            // Full history is preserved in localStorage
            const limitedHistory = history.slice(Math.max(0, history.length - 20));
            const adjustedHistoryIndex = historyIndex - Math.max(0, history.length - 20);
            
            const now = new Date().toISOString();
            const timestamp = Date.now();
            
            const data = {
                employees: cleanedEmployees,
                history: JSON.stringify(limitedHistory),
                historyIndex: adjustedHistoryIndex >= 0 ? adjustedHistoryIndex : 0,
                lastUpdated: now,
                timestamp: timestamp  // Add numeric timestamp for easy comparison
            };

            // Save FULL history to localStorage (no size limit concerns)
            localStorage.setItem('nailSalonData', JSON.stringify({
                employees: employees,
                history: history,
                historyIndex: historyIndex,
                lastSyncTimestamp: timestamp  // Track when we last synced
            }));

            // Only sync to Firebase if both Firebase is enabled AND user has sync enabled
            if (firebaseEnabled && syncEnabled) {
                try {
                    updateSyncStatus('saving');
                    await db.collection('nailSalon').doc('data').set(data);
                    updateSyncStatus('synced');
                    console.log(`‚úÖ Saved to Firebase with timestamp: ${timestamp}`);
                } catch (error) {
                    console.error('Firebase save error:', error);
                    updateSyncStatus('error');
                }
            } else if (!syncEnabled) {
                // User has disabled sync
                updateSyncStatus('offline');
            }
        }

        function updateSyncStatus(status) {
            syncStatus = status;
            const icon = document.getElementById('syncIcon');
            const textEl = document.getElementById('syncText');
            
            icon.className = 'sync-icon ' + status;
            
            if (status === 'synced') {
                lastSync = new Date();
                textEl.textContent = '‚òÅÔ∏è Cloud Synced ' + lastSync.toLocaleTimeString();
            } else if (status === 'saving') {
                textEl.textContent = '‚òÅÔ∏è Syncing to cloud...';
            } else if (status === 'error') {
                textEl.textContent = '‚ùå Sync error - Check console for details';
            } else if (status === 'offline') {
                if (!firebaseEnabled) {
                    textEl.textContent = 'üíæ Offline - Firebase not configured';
                } else if (!syncEnabled) {
                    textEl.textContent = 'üíæ Offline - Sync disabled by user';
                } else {
                    textEl.textContent = 'üíæ Offline mode - localStorage only';
                }
            }
        }

        // ========================================
        // HISTORY MANAGEMENT
        // ========================================
        function saveToHistory() {
            history = history.slice(0, historyIndex + 1);
            history.push(JSON.parse(JSON.stringify(employees)));
            historyIndex = history.length - 1;
            
            // Limit history to last 100 entries to prevent localStorage from growing too large
            // This still provides plenty of undo/redo capability
            if (history.length > 100) {
                const removeCount = history.length - 100;
                history = history.slice(removeCount);
                historyIndex = historyIndex - removeCount;
                if (historyIndex < 0) historyIndex = 0;
            }
            
            updateButtons();
            saveData();
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                employees = JSON.parse(JSON.stringify(history[historyIndex]));
                updateButtons();
                saveData();
                render();
                addAuditLog('working', 'Undo action performed');
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                employees = JSON.parse(JSON.stringify(history[historyIndex]));
                updateButtons();
                saveData();
                render();
                addAuditLog('working', 'Redo action performed');
            }
        }

        function updateButtons() {
            document.getElementById('undoBtn').disabled = historyIndex <= 0;
            document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
        }

        // ========================================
        // EMPLOYEE MANAGEMENT
        // ========================================
        function setTurn(index, value) {
            const oldTurn = employees[index].turn;
            const newTurn = value === '' ? null : parseInt(value);
            const now = Date.now();
            
            employees[index].turn = newTurn;
            employees[index].lastUpdated = now;
            
            // Lock sync for 2 seconds to prevent immediate overwrite
            lastLocalUpdate = now;
            syncLockUntil = now + 2000;
            
            saveToHistory();
            render();
            
            const turnText = newTurn === null ? 'removed' : `#${newTurn}`;
            const oldText = oldTurn === null ? 'no turn' : `#${oldTurn}`;
            addAuditLog('turn', `${employees[index].name}: Turn changed from ${oldText} to ${turnText}`);
        }

        function clockIn(index) {
            const maxTurn = Math.max(0, ...employees.map(e => e.turn || 0));
            const now = Date.now();
            
            employees[index].turn = maxTurn + 1;
            employees[index].status = 'waiting';
            employees[index].lastUpdated = now;
            
            // Lock sync for 2 seconds to prevent immediate overwrite
            lastLocalUpdate = now;
            syncLockUntil = now + 2000;
            
            saveToHistory();
            render();
            addAuditLog('turn', `${employees[index].name}: Clocked in with turn #${maxTurn + 1}`);
        }

        function setWorking(index) {
            const now = Date.now();
            
            employees[index].status = 'working';
            employees[index].turn = null;
            employees[index].halfTurn = false;  // Reset half-turn when working
            employees[index].lastUpdated = now;
            
            // Lock sync for 2 seconds to prevent immediate overwrite
            lastLocalUpdate = now;
            syncLockUntil = now + 2000;
            
            startTimer(index);
            saveToHistory();
            render();
            addAuditLog('working', `${employees[index].name}: Status changed to WORKING (timer started)`);
        }

        function setDone(index) {
            const employee = employees[index];
            const now = Date.now();
            
            stopTimer(index);
            saveToWorkHistory(index);
            
            const maxTurn = Math.max(0, ...employees.map(e => e.turn || 0));
            employee.status = 'waiting';
            employee.turn = maxTurn + 1;
            employee.lastUpdated = now;
            
            // Lock sync for 2 seconds to prevent immediate overwrite
            lastLocalUpdate = now;
            syncLockUntil = now + 2000;
            
            // Properly remove workStartTime property
            if (employee.workStartTime !== undefined) {
                delete employee.workStartTime;
            }
            
            saveToHistory();
            render();
        }

        function toggleHalfTurn(index) {
            const now = Date.now();
            
            // Toggle half-turn status
            employees[index].halfTurn = !employees[index].halfTurn;
            employees[index].lastUpdated = now;
            
            // Lock sync for 2 seconds to prevent immediate overwrite
            lastLocalUpdate = now;
            syncLockUntil = now + 2000;
            
            saveToHistory();
            render();
            
            const status = employees[index].halfTurn ? 'marked as half turn' : 'unmarked as half turn';
            addAuditLog('turn', `${employees[index].name}: ${status}`);
        }

        function addEmployee() {
            const input = document.getElementById('newEmployeeName');
            const name = input.value.trim();
            if (name) {
                employees.push({ name: name, turn: null, status: 'waiting', birthMonth: null, birthDay: null });
                render();
                input.value = '';
                input.focus();
            }
        }

        function showAddEmployeeModal() {
            editingEmployeeIndex = null;
            document.getElementById('addModalTitle').textContent = '‚ûï Add New Employee';
            document.getElementById('addModalBtn').textContent = 'Add Employee';
            document.getElementById('addEmployeeModal').classList.add('show');
            document.getElementById('newEmpName').value = '';
            document.getElementById('newEmpMonth').value = '';
            document.getElementById('newEmpDay').value = '';
            document.getElementById('newEmpBirthdayReminder').checked = true;
            document.getElementById('newEmpName').focus();
        }

        function hideAddEmployeeModal() {
            editingEmployeeIndex = null;
            document.getElementById('addEmployeeModal').classList.remove('show');
            document.getElementById('newEmpName').value = '';
            document.getElementById('newEmpMonth').value = '';
            document.getElementById('newEmpDay').value = '';
        }

        function confirmAddEmployee() {
            const name = document.getElementById('newEmpName').value.trim();
            const month = parseInt(document.getElementById('newEmpMonth').value);
            const day = parseInt(document.getElementById('newEmpDay').value);
            const birthdayReminderEnabled = document.getElementById('newEmpBirthdayReminder').checked;
            const now = Date.now();
            
            if (!name) {
                alert('Please enter employee name');
                return;
            }
            
            if (month && (month < 1 || month > 12)) {
                alert('Month must be between 1 and 12');
                return;
            }
            
            if (day && (day < 1 || day > 31)) {
                alert('Day must be between 1 and 31');
                return;
            }
            
            if (editingEmployeeIndex !== null) {
                const oldName = employees[editingEmployeeIndex].name;
                const oldBday = employees[editingEmployeeIndex].birthMonth && employees[editingEmployeeIndex].birthDay 
                    ? `${employees[editingEmployeeIndex].birthMonth}/${employees[editingEmployeeIndex].birthDay}` 
                    : 'not set';
                const newBday = month && day ? `${month}/${day}` : 'not set';
                
                employees[editingEmployeeIndex].name = name;
                employees[editingEmployeeIndex].birthMonth = month || null;
                employees[editingEmployeeIndex].birthDay = day || null;
                employees[editingEmployeeIndex].birthdayReminderEnabled = birthdayReminderEnabled;
                employees[editingEmployeeIndex].lastUpdated = now;
                
                addAuditLog('edit', `Employee edited: ${oldName} ‚Üí ${name}, Birthday: ${oldBday} ‚Üí ${newBday}, Reminder: ${birthdayReminderEnabled ? 'ON' : 'OFF'}`);
            } else {
                const bday = month && day ? `${month}/${day}` : 'not set';
                employees.push({ 
                    name: name, 
                    turn: null, 
                    status: 'waiting',
                    halfTurn: false,
                    birthMonth: month || null,
                    birthDay: day || null,
                    birthdayReminderEnabled: birthdayReminderEnabled,
                    lastUpdated: now
                });
                addAuditLog('add', `New employee added: ${name}, Birthday: ${bday}, Reminder: ${birthdayReminderEnabled ? 'ON' : 'OFF'}`);
            }
            
            // Lock sync for 2 seconds to prevent immediate overwrite
            lastLocalUpdate = now;
            syncLockUntil = now + 2000;
            
            saveToHistory();
            render();
            renderEmployeeList();
            hideAddEmployeeModal();
        }

        function editEmployee(index) {
            editingEmployeeIndex = index;
            const emp = employees[index];
            
            document.getElementById('addModalTitle').textContent = '‚úèÔ∏è Edit Employee';
            document.getElementById('addModalBtn').textContent = 'Save Changes';
            document.getElementById('newEmpName').value = emp.name;
            document.getElementById('newEmpMonth').value = emp.birthMonth || '';
            document.getElementById('newEmpDay').value = emp.birthDay || '';
            document.getElementById('newEmpBirthdayReminder').checked = emp.birthdayReminderEnabled !== false;
            document.getElementById('addEmployeeModal').classList.add('show');
            document.getElementById('newEmpName').focus();
        }

        function deleteEmployee(index) {
            console.log('Opening delete confirmation for index:', index);
            pendingDeleteIndex = index;
            const empName = employees[index].name;
            document.getElementById('deleteEmployeeText').textContent = `Are you sure you want to permanently delete ${empName}?`;
            document.getElementById('deleteEmployeeModal').classList.add('show');
        }

        function cancelDeleteEmployee() {
            console.log('Delete cancelled');
            document.getElementById('deleteEmployeeModal').classList.remove('show');
            pendingDeleteIndex = null;
        }

        function confirmDeleteEmployee() {
            console.log('Deleting employee at index:', pendingDeleteIndex);
            if (pendingDeleteIndex !== null && employees[pendingDeleteIndex]) {
                const empName = employees[pendingDeleteIndex].name;
                const empBday = employees[pendingDeleteIndex].birthMonth && employees[pendingDeleteIndex].birthDay
                    ? `${employees[pendingDeleteIndex].birthMonth}/${employees[pendingDeleteIndex].birthDay}`
                    : 'not set';
                
                employees.splice(pendingDeleteIndex, 1);
                console.log('‚úÖ Employee deleted:', empName);
                console.log('Remaining employees:', employees.length);
                
                addAuditLog('delete', `Employee permanently deleted: ${empName}, Birthday: ${empBday}`);
                
                saveToHistory();
                render();
                renderEmployeeList();
            }
            document.getElementById('deleteEmployeeModal').classList.remove('show');
            pendingDeleteIndex = null;
        }

        function toggleDropdown() {
            document.getElementById('dropdownMenu').classList.toggle('show');
        }

        function showMainPage() {
            document.getElementById('mainPage').classList.add('active');
            document.getElementById('settingsPage').classList.remove('active');
            document.getElementById('employeeListPage').classList.remove('active');
            document.getElementById('auditLogPage').classList.remove('active');
            document.getElementById('workHistoryPage').classList.remove('active');
            document.getElementById('dropdownMenu').classList.remove('show');
        }

        function showEmployeeList() {
            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('settingsPage').classList.remove('active');
            document.getElementById('employeeListPage').classList.add('active');
            document.getElementById('auditLogPage').classList.remove('active');
            document.getElementById('workHistoryPage').classList.remove('active');
            document.getElementById('dropdownMenu').classList.remove('show');
            renderEmployeeList();
        }

        function renderEmployeeList() {
            const list = document.getElementById('employeeInfoList');
            const sortedEmps = [...employees].sort((a, b) => a.name.localeCompare(b.name));
            
            list.innerHTML = sortedEmps.map((emp) => {
                const actualIndex = employees.indexOf(emp);
                const birthday = emp.birthMonth && emp.birthDay 
                    ? `${emp.birthMonth}/${emp.birthDay}` 
                    : 'Not set';
                    
                return `
                    <div class="employee-info-card">
                        <div class="info">
                            <h3>${emp.name}${shouldShowBirthdayCake(emp.birthMonth, emp.birthDay, emp.birthdayReminderEnabled) ? ' üéÇ' : ''}</h3>
                            <p>üéÇ Birthday: ${birthday}</p>
                        </div>
                        <div class="actions">
                            <button class="btn-primary btn-small" onclick="editEmployee(${actualIndex})">‚úèÔ∏è Edit</button>
                            <button class="btn-danger btn-small" onclick="deleteEmployee(${actualIndex})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.onclick = function(event) {
            if (!event.target.matches('.btn-primary') && !event.target.closest('.dropdown')) {
                document.getElementById('dropdownMenu').classList.remove('show');
            }
        }

        function removeEmployee(index) {
            console.log('Opening hide confirmation for index:', index);
            pendingHideIndex = index;
            const empName = employees[index].name;
            document.getElementById('hideEmployeeText').textContent = `Hide ${empName} from the queue?`;
            document.getElementById('hideEmployeeModal').classList.add('show');
        }

        function cancelHideEmployee() {
            console.log('Hide cancelled');
            document.getElementById('hideEmployeeModal').classList.remove('show');
            pendingHideIndex = null;
        }

        function confirmHideEmployee() {
            console.log('Hiding employee at index:', pendingHideIndex);
            if (pendingHideIndex !== null && employees[pendingHideIndex]) {
                const empName = employees[pendingHideIndex].name;
                const now = Date.now();
                
                employees[pendingHideIndex].turn = null;
                employees[pendingHideIndex].status = 'hidden';
                employees[pendingHideIndex].lastUpdated = now;
                console.log('‚úÖ Employee hidden:', empName);
                
                // Lock sync for 2 seconds to prevent immediate overwrite
                lastLocalUpdate = now;
                syncLockUntil = now + 2000;
                
                addAuditLog('hide', `Employee hidden from queue: ${empName}`);
                
                saveToHistory();
                render();
            }
            document.getElementById('hideEmployeeModal').classList.remove('show');
            pendingHideIndex = null;
        }

        function handleDragStartByDisplay(e, displayIdx) {
            draggedIndex = displayIdx;
            console.log('Drag started at display index:', displayIdx);
            
            e.currentTarget.classList.add('dragging');
            e.currentTarget.setAttribute('data-index', displayIdx);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', displayIdx);
            e.currentTarget.style.webkitUserSelect = 'none';
            e.currentTarget.style.userSelect = 'none';
        }

        function handleDragStart(e, index) {
            const displayList = editMode ? 
                (() => {
                    const withNumbers = employees.filter(e => e.turn !== null && e.status === 'waiting').sort((a, b) => a.turn - b.turn);
                    const working = employees.filter(e => e.status === 'working');
                    const withoutNumbers = employees.filter(e => e.turn === null && e.status === 'waiting');
                    return [...withNumbers, ...working, ...withoutNumbers];
                })() : 
                getSortedEmployees();
            
            const employee = employees[index];
            draggedIndex = displayList.indexOf(employee);
            
            console.log('Drag started - Employee:', employee.name, 'Display index:', draggedIndex);
            
            e.currentTarget.classList.add('dragging');
            e.currentTarget.setAttribute('data-index', draggedIndex);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedIndex);
            e.currentTarget.style.webkitUserSelect = 'none';
            e.currentTarget.style.userSelect = 'none';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e, dropIndex) {
            e.preventDefault();
            
            const displayList = editMode ? 
                (() => {
                    const withNumbers = employees.filter(e => e.turn !== null && e.status === 'waiting').sort((a, b) => a.turn - b.turn);
                    const working = employees.filter(e => e.status === 'working');
                    const withoutNumbers = employees.filter(e => e.turn === null && e.status === 'waiting');
                    return [...withNumbers, ...working, ...withoutNumbers];
                })() : 
                getSortedEmployees();
            
            const employee = employees[dropIndex];
            const displayIdx = displayList.indexOf(employee);
            
            if (draggedIndex !== displayIdx) {
                document.querySelectorAll('.employee-row').forEach(row => {
                    row.classList.remove('drag-over');
                });
                e.currentTarget.classList.add('drag-over');
            }
        }

        function handleDragEnterByDisplay(e, displayIdx) {
            e.preventDefault();
            if (draggedIndex !== displayIdx) {
                document.querySelectorAll('.employee-row').forEach(row => {
                    row.classList.remove('drag-over');
                });
                e.currentTarget.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX;
            const y = e.clientY;
            
            const padding = 20;
            if (x < rect.left - padding || x > rect.right + padding || 
                y < rect.top - padding || y > rect.bottom + padding) {
                e.currentTarget.classList.remove('drag-over');
            }
        }

        function handleDrop(e, dropIndex) {
            e.preventDefault();
            e.stopPropagation();
            
            document.querySelectorAll('.employee-row').forEach(row => {
                row.classList.remove('drag-over');
                row.style.webkitUserSelect = '';
                row.style.userSelect = '';
            });
            
            if (draggedIndex !== null && draggedIndex !== dropIndex) {
                console.log('Drag from display index', draggedIndex, 'to', dropIndex);
                
                const displayList = editMode ? 
                    (() => {
                        const withNumbers = employees.filter(e => e.turn !== null && e.status === 'waiting').sort((a, b) => a.turn - b.turn);
                        const working = employees.filter(e => e.status === 'working');
                        const withoutNumbers = employees.filter(e => e.turn === null && e.status === 'waiting');
                        return [...withNumbers, ...working, ...withoutNumbers];
                    })() : 
                    getSortedEmployees();
                
                const draggedEmployee = displayList[draggedIndex];
                const targetEmployee = displayList[dropIndex];
                
                console.log('Swapping:', draggedEmployee.name, 'with', targetEmployee.name);
                console.log('Before swap - Dragged turn:', draggedEmployee.turn, 'Target turn:', targetEmployee.turn);
                
                const tempTurn = draggedEmployee.turn;
                draggedEmployee.turn = targetEmployee.turn;
                targetEmployee.turn = tempTurn;
                
                console.log('After swap - Dragged turn:', draggedEmployee.turn, 'Target turn:', targetEmployee.turn);
                
                if (tempTurn !== null || targetEmployee.turn !== null) {
                    const dragTurnText = draggedEmployee.turn !== null ? `Turn #${draggedEmployee.turn}` : 'no turn';
                    const targetTurnText = targetEmployee.turn !== null ? `Turn #${targetEmployee.turn}` : 'no turn';
                    addAuditLog('reorder', `Swapped: ${draggedEmployee.name} (${dragTurnText}) ‚Üî ${targetEmployee.name} (${targetTurnText})`);
                }
                
                saveToHistory();
                render();
            }
            
            draggedIndex = null;
            return false;
        }

        function handleDropByDisplay(e, displayIdx) {
            e.preventDefault();
            e.stopPropagation();
            
            document.querySelectorAll('.employee-row').forEach(row => {
                row.classList.remove('drag-over');
                row.style.webkitUserSelect = '';
                row.style.userSelect = '';
            });
            
            if (draggedIndex !== null && draggedIndex !== displayIdx) {
                console.log('Drop: swapping display positions', draggedIndex, 'and', displayIdx);
                
                const displayList = editMode ? 
                    (() => {
                        const withNumbers = employees.filter(e => e.turn !== null && e.status === 'waiting').sort((a, b) => a.turn - b.turn);
                        const working = employees.filter(e => e.status === 'working');
                        const withoutNumbers = employees.filter(e => e.turn === null && e.status === 'waiting');
                        return [...withNumbers, ...working, ...withoutNumbers];
                    })() : 
                    getSortedEmployees();
                
                const draggedEmployee = displayList[draggedIndex];
                const targetEmployee = displayList[displayIdx];
                
                console.log('Swapping turns:', draggedEmployee.name, '(Turn', draggedEmployee.turn, ') ‚Üî', targetEmployee.name, '(Turn', targetEmployee.turn, ')');
                
                const tempTurn = draggedEmployee.turn;
                draggedEmployee.turn = targetEmployee.turn;
                targetEmployee.turn = tempTurn;
                
                console.log('After swap:', draggedEmployee.name, '(Turn', draggedEmployee.turn, '),', targetEmployee.name, '(Turn', targetEmployee.turn, ')');
                
                const dragTurnText = draggedEmployee.turn !== null ? `Turn #${draggedEmployee.turn}` : 'no turn';
                const targetTurnText = targetEmployee.turn !== null ? `Turn #${targetEmployee.turn}` : 'no turn';
                addAuditLog('reorder', `Swapped: ${draggedEmployee.name} (${dragTurnText}) ‚Üî ${targetEmployee.name} (${targetTurnText})`);
                
                saveToHistory();
                render();
            }
            
            draggedIndex = null;
            return false;
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            e.currentTarget.removeAttribute('data-index');
            document.querySelectorAll('.employee-row').forEach(row => {
                row.classList.remove('drag-over');
                row.style.webkitUserSelect = '';
                row.style.userSelect = '';
            });
            draggedIndex = null;
        }

        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('editModeBtn');
            
            if (editMode) {
                employeesBackup = JSON.parse(JSON.stringify(employees));
                btn.textContent = 'Save';
                btn.classList.add('active');
                btn.onclick = function() { toggleEditMode(); };
            } else {
                employeesBackup = null;
                btn.textContent = 'Edit';
                btn.classList.remove('active');
                btn.onclick = function() { showPasscodeModal(); };
                saveToHistory();
                addAuditLog('working', 'Edit mode deactivated, changes saved');
            }
            render();
        }

        function cancelEdit() {
            if (employeesBackup) {
                employees = employeesBackup;
                employeesBackup = null;
            }
            editMode = false;
            const btn = document.getElementById('editModeBtn');
            btn.textContent = 'Edit';
            btn.classList.remove('active');
            render();
            addAuditLog('working', 'Edit mode cancelled, changes discarded');
        }

        function showClearModal() {
            document.getElementById('clearModal').classList.add('show');
        }

        function hideClearModal() {
            document.getElementById('clearModal').classList.remove('show');
        }

        function confirmClearAll() {
            const hiddenCount = employees.filter(e => e.status === 'hidden').length;
            const now = Date.now();
            
            // Stop all timers and properly clean up working employees
            employees.forEach((emp, index) => {
                if (emp.status === 'working') {
                    stopTimer(index);
                }
            });
            
            // Clear all turns and statuses, unhide hidden employees
            // Create completely clean objects with NO undefined values
            employees = employees.map(emp => {
                const cleaned = { 
                    name: emp.name,
                    turn: null, 
                    status: 'waiting',
                    halfTurn: false,
                    lastUpdated: now
                };
                
                // Only add birthday fields if they exist and are not null/undefined
                if (emp.birthMonth !== null && emp.birthMonth !== undefined) {
                    cleaned.birthMonth = emp.birthMonth;
                } else {
                    cleaned.birthMonth = null;
                }
                
                if (emp.birthDay !== null && emp.birthDay !== undefined) {
                    cleaned.birthDay = emp.birthDay;
                } else {
                    cleaned.birthDay = null;
                }
                
                // Handle birthday reminder setting
                if (emp.birthdayReminderEnabled !== undefined) {
                    cleaned.birthdayReminderEnabled = emp.birthdayReminderEnabled;
                } else {
                    cleaned.birthdayReminderEnabled = true;
                }
                
                return cleaned;
            });
            
            // Lock sync for 2 seconds to prevent immediate overwrite
            lastLocalUpdate = now;
            syncLockUntil = now + 2000;
            
            saveToHistory();
            render();
            hideClearModal();
            
            addAuditLog('clear', `All turns and statuses cleared. ${hiddenCount} hidden employee(s) restored. All working employees reset.`);
        }

        // ========================================
        // RENDERING
        // ========================================
        function getSortedEmployees() {
            const waitingWithNumbers = employees.filter(e => e.turn !== null && e.status === 'waiting').sort((a, b) => a.turn - b.turn);
            const working = employees.filter(e => e.status === 'working');
            const waitingWithoutNumbers = employees.filter(e => e.turn === null && e.status === 'waiting');
            return [...waitingWithNumbers, ...working, ...waitingWithoutNumbers];
        }

        function render() {
            let displayList;
            if (editMode) {
                const withNumbers = employees.filter(e => e.turn !== null && e.status === 'waiting').sort((a, b) => a.turn - b.turn);
                const working = employees.filter(e => e.status === 'working');
                const withoutNumbers = employees.filter(e => e.turn === null && e.status === 'waiting');
                displayList = [...withNumbers, ...working, ...withoutNumbers];
            } else {
                displayList = getSortedEmployees();
            }
            
            const waitingWithNumbers = employees.filter(e => e.turn !== null && e.status === 'waiting').sort((a, b) => a.turn - b.turn);
            const working = employees.filter(e => e.status === 'working');
            const nextEmployee = waitingWithNumbers.length > 0 ? waitingWithNumbers[0] : null;

            const nextBanner = document.getElementById('nextBanner');
            if (nextEmployee) {
                nextBanner.innerHTML = `
                    <p>Next Turn:</p>
                    <p class="name">${nextEmployee.name}${shouldShowBirthdayCake(nextEmployee.birthMonth, nextEmployee.birthDay, nextEmployee.birthdayReminderEnabled) ? ' üéÇ' : ''}</p>
                    <p class="turn">Turn #${nextEmployee.turn}</p>
                `;
                nextBanner.className = 'next-banner';
                nextBanner.style.display = 'block';
            } else {
                nextBanner.style.display = 'none';
            }

            const currentlyWorking = working.length;
            const workingToday = waitingWithNumbers.length + working.length;
            document.getElementById('workingCount').textContent = 
                `Working Today: ${workingToday}/${employees.length} | Currently Working: ${currentlyWorking}`;

            const list = document.getElementById('employeeList');
            list.innerHTML = displayList.map((emp, displayIdx) => {
                const actualIndex = employees.indexOf(emp);
                
                return `
                    <div class="employee-row ${emp.status === 'working' ? 'working' : ''} ${emp.halfTurn ? 'half-turn' : ''} ${editMode ? 'edit-mode-row' : ''}" 
                        data-actual-index="${actualIndex}"
                        data-display-index="${displayIdx}"
                        draggable="${editMode ? 'true' : 'false'}" 
                        ondragstart="${editMode ? 'handleDragStartByDisplay(event, ' + displayIdx + ')' : 'return false;'}"
                        ondragover="${editMode ? 'handleDragOver(event)' : 'return false;'}"
                        ondragenter="${editMode ? 'handleDragEnterByDisplay(event, ' + displayIdx + ')' : 'return false;'}"
                        ondragleave="${editMode ? 'handleDragLeave(event)' : 'return false;'}"
                        ondrop="${editMode ? 'handleDropByDisplay(event, ' + displayIdx + ')' : 'return false;'}"
                        ondragend="${editMode ? 'handleDragEnd(event)' : 'return false;'}">
                        ${editMode ? `
                            <div class="drag-handle" style="min-width: 40px; min-height: 40px; display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M9 3h2v2H9V3zm0 4h2v2H9V7zm0 4h2v2H9v-2zm0 4h2v2H9v-2zm0 4h2v2H9v-2zm4-16h2v2h-2V3zm0 4h2v2h-2V7zm0 4h2v2h-2v-2zm0 4h2v2h-2v-2zm0 4h2v2h-2v-2z"/>
                                </svg>
                            </div>
                        ` : ''}
                        <div class="employee-name">
                            <span>${emp.name}${shouldShowBirthdayCake(emp.birthMonth, emp.birthDay, emp.birthdayReminderEnabled) ? ' üéÇ' : ''}</span>
                            ${editMode ? `
                                <button class="remove-btn" onclick="event.stopPropagation(); console.log('X clicked for index: ${actualIndex}'); removeEmployee(${actualIndex}); return false;">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
                        ${emp.status === 'working' ? `
                            ${showTimer ? `<div class="timer-display ${getTimerClass(emp.workStartTime)}" data-timer-index="${actualIndex}">${getElapsedTime(emp.workStartTime)}</div>` : ''}
                            <button class="btn-success btn-action" onclick="setDone(${actualIndex})">Done</button>
                        ` : `
                            ${!editMode && emp.turn !== null ? `
                                <button class="half-turn-btn ${emp.halfTurn ? 'active' : ''}" onclick="toggleHalfTurn(${actualIndex})" title="Mark as half turn">
                                    ${emp.halfTurn ? '‚úì' : '¬Ω'}
                                </button>
                            ` : ''}
                            <input type="number" class="turn-input" 
                                value="${emp.turn === null ? '' : emp.turn}" 
                                placeholder="--"
                                onchange="setTurn(${actualIndex}, this.value)">
                            ${emp.turn === null ? `
                                <button class="btn-success btn-action" onclick="clockIn(${actualIndex})">Clock-in</button>
                            ` : `
                                <button class="btn-warning btn-action" onclick="setWorking(${actualIndex})">Working</button>
                            `}
                        `}
                    </div>
                `;
            }).join('');

            updateButtons();
            
            const cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) {
                cancelBtn.style.display = editMode ? 'block' : 'none';
            }
        }

        // ========================================
        // START THE APP
        // ========================================
        window.onload = function() {
            init();
            requestWakeLock();
        };
    </script>
</body>
</html>
